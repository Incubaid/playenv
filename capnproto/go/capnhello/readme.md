# Go-Cap'n Proto tutorial
`Cap’n Proto is an insanely fast data interchange format and capability-based RPC system. Think JSON, except binary. Or think Protocol Buffers, except faster. In fact, in benchmarks, Cap’n Proto is INFINITY TIMES faster than Protocol Buffers.`

Pros:
- Does the Job
- Fast (Due to it's random access feature as It doesn't `parse` the data first).

Cons:
- Kinda complex in a way with Go bindings
    
## Installation
    1- https://capnproto.org/install.html
    2- go get -u -t zombiezen.com/go/capnproto2/

## How to use it
1- Write down your schema

```
using Go = import "../../zombiezen/go-capnproto2/go.capnp";
@0x85d3acc39d94e0f8;
$Go.package("data");
$Go.import("data/books");

struct Book {
    id @0 : Int64;
    title @1 :Text;
    author @2: Text;
}
```
    Note: you generate the capnp id by running ```capnpn id```
2- Generate the code for Go 
```capnp compile -ogo programmerschema.capnp```
### Examples
#### Book 
1- You need to define the schema first. That's the easy part.
```
using Go = import "../../zombiezen/go-capnproto2/go.capnp";
@0x85d3acc39d94e0f8;
$Go.package("data");
$Go.import("data/books");

struct Book {
    id @0 : Int64;
    title @1 :Text;
    author @2: Text;
}
```

2- ```capnp compile -ogo programmerschema.capnp```

3- Create/Serialize/Deserialize the `Book`

Note: Cap'n proto uses the term `Message` for whatever it "serialize/deserialize"
```go
func dumpbook() *bytes.Buffer {
	buf := new(bytes.Buffer)
	msg, seg, err := capnp.NewMessage(capnp.SingleSegment(nil)) //this is the initialization of the message.
	if err != nil {
		panic(err)
	}
	b, _ := data.NewRootBook(seg) //The root of the Message (Book)
    //setting some data
	b.SetId(31)
	b.SetTitle("Fake title")
	b.SetAuthor("Fake author name")
    //encoding the message :: Take a look at msg.Marshal() 
	err = capnp.NewEncoder(buf).Encode(msg)
	if err != nil {
		panic(err)
	}
	return buf
}
func loadbook(buf *bytes.Buffer) {
    //decode the data :: Take a look at capnp.Unmarshal() 
	d, err := capnp.NewDecoder(buf).Decode()
	if err != nil {
		panic(err)
	}
	//read the root of the message (Book)
	b, errx := data.ReadRootBook(d)
	if errx != nil {
		panic(errx)
	}
	//Get the fields 
	id := b.Id()
	title, _ := b.Title()
	author, _ := b.Author()
	fmt.Println(id, title, author)
}
func main() {
	loadbook(dumpbook())
}


```
### Programmer example
1-Schema
```
using Go = import "../../zombiezen/go-capnproto2/go.capnp";
@0xdbb9ad1f14bf0b37;  # unique file ID, generated by `capnp id`
$Go.package("data");
$Go.import("data/programmer");


struct Programmer {
  name @0 :Text;
  email @1 :Text;
  likes @2 :List(Text);

}


```
2- Create/Dump/Load 
Note: If you got lists as an attributes of your you need to initialize them first 
```go
	likes, _ := p.NewLikes(3)
	likes.Set(0, "python")
	likes.Set(1, "haskell")
	likes.Set(2, "go")
	p.SetLikes(likes)
```

```go

func dumpprogrammer() *bytes.Buffer {
	buf := new(bytes.Buffer)
	msg, seg, err := capnp.NewMessage(capnp.SingleSegment(nil))
	if err != nil {
		panic(err)
	}
	p, _ := data.NewRootProgrammer(seg)

	p.SetName("ahmed")
	p.SetEmail("ahmed@there.com")
	likes, _ := p.NewLikes(3)
	likes.Set(0, "python")
	likes.Set(1, "haskell")
	likes.Set(2, "go")
	p.SetLikes(likes)

	err = capnp.NewEncoder(buf).Encode(msg)
	if err != nil {
		panic(err)
	}
	return buf
}
func loadprogrammer(buf *bytes.Buffer) {

	d, err := capnp.NewDecoder(buf).Decode()
	if err != nil {
		panic(err)
	}
	p, err := data.ReadRootProgrammer(d)
	if err != nil {
		panic(err)
	}
	fmt.Println(p)
}
```
There is a more complex example in the tutorial files 
